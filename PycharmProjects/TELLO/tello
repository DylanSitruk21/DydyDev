import socket
import threading
import time
import cv2


class Tello:
    def __init__(self):
        self.ip = '192.168.10.1'
        self.command_port = 8889
        self.address = (self.ip, self.command_port)
        self.response = None
        self.overtime = 3

        self.lock = threading.RLock()

        self.video_port = 11111

        self.socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.video_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

        self.socket.bind(('', self.command_port))

        # init command and video stream

        self.receive_thread = threading.Thread(target=self.receive_response)
        self.receive_thread.daemon = True

        self.socket.sendto(b'command', self.address)
        print('sent: command')
        last_send = time.time()

        self.receive_thread.start()

        while self.response != b'ok':
            if time.time() - last_send >= self.overtime:
                self.socket.sendto(b'command', self.address)
                # print(str(self.response))
                print('sent: command')
                last_send = time.time()

        # video stream

        self.video_socket.bind(('', self.video_port))

        self.receive_video_thread = threading.Thread(target=self.receive_video_data)
        self.receive_video_thread.daemon = True
        self.receive_video_thread.start()

        self.socket.sendto(b'streamon', self.address)
        print('sent: streamon')

    def receive_response(self):
        while True:
            self.response, ip = self.socket.recvfrom(3000)
            if self.response:
                print(str(self.response))

    def receive_video_data(self):
        self.video_data = None
        packet_data = ""
        while True:
            data, ip = self.video_socket.recvfrom(2048)
            print('Coucouccc')
            print(type(data))

            if data:
                print(str(data))
            packet_data += data
            # end of frame

            if len(data) != 1460:
                for frame in self._h264_decode(packet_data):
                    self.frame = fr

    def send_command(self, command):
        self.socket.sendto(command.encode('utf-8'), self.address)

    # control command:

    def takeoff(self):
        self.send_command('takeoff')

    def land(self):
        self.send_command('land')


drone = Tello()
time.sleep(5)